<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VR街づくりテスト – Horizon Worlds 操作版</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:black; }
    #startVR{
      position:fixed;top:20px;left:20px;z-index:10;
      padding:10px 20px;font-size:1.2em;
      background:#4CAF50;color:#fff;border:none;border-radius:5px;
      cursor:pointer;
    }
  </style>
</head>
<body>
<button id="startVR">VRモード開始</button>

<script>
/* ───────────── 基本セットアップ ───────────────────── */
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x222222);

/* プレイヤーリグ（カメラを包む外殻） */
const playerRig = new THREE.Group();
scene.add(playerRig);

const camera = new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,1.6,3);
playerRig.add(camera);

/* 環境ライト */
scene.add(new THREE.AmbientLight(0xffffff,0.5));
const hemi = new THREE.HemisphereLight(0xffffff,0x444444);
hemi.position.set(0,10,0);
scene.add(hemi);

/* グリッド床とデモオブジェクト */
scene.add(new THREE.GridHelper(50,50));

const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshNormalMaterial());
cube.position.set(0,1.6,-4); scene.add(cube);

const sphere = new THREE.Mesh(new THREE.SphereGeometry(0.7,32,32),new THREE.MeshBasicMaterial({color:0x00ffff}));
sphere.position.set(3,2,-5); scene.add(sphere);

/* 小ビル群 */
for(let i=-10;i<=10;i+=4){
  for(let j=-10;j<=10;j+=4){
    if(i===0&&j===0) continue;
    const h=Math.random()*5+2;
    const b=new THREE.Mesh(new THREE.BoxGeometry(1,h,1),new THREE.MeshStandardMaterial({color:0x888888}));
    b.position.set(i,h/2,j-10); scene.add(b);
  }
}

/* ───────────── コントローラ入力 ─────────────────── */
const MOVE_SPEED = 0.05;     // m/フレーム
const JUMP_SPEED = 0.19;     // 初速
const GRAVITY    = 0.0098;   // 下向き加速度
const SNAP_ANGLE = Math.PI/4;// 45°
const SNAP_DEAD  = 0.7;      // スナップ開始のしきい値
const SNAP_COOL  = 300;      // ms

playerRig.userData.yVel = 0;
playerRig.userData.canJump = true;
let lastSnap = 0;

/* ───────────── メインループ ─────────────────────── */
const tmpFwd  = new THREE.Vector3();
const tmpRight= new THREE.Vector3();

renderer.setAnimationLoop((time,frame)=>{
  /* デモ回転 */
  cube.rotation.x += 0.01;
  cube.rotation.y += 0.01;
  sphere.rotation.y += 0.02;

  const session = renderer.xr.getSession();
  if(session && frame){
    for(const src of session.inputSources){
      if(!src.gamepad) continue;
      const g = src.gamepad;

      /* 軸インデックス (Quest=2/3, fallback=0/1) */
      const xi = g.axes.length >= 4 ? 2 : 0;
      const yi = xi + 1;
      const x  = g.axes[xi];
      const y  = g.axes[yi];

      /* 初回フレームで prevButtons を用意 */
      if(!src.userData.prevButtons){
        src.userData.prevButtons = g.buttons.map(b=>b.pressed);
      }

      /* 左コントローラー：移動 */
      if(src.handedness === 'left'){
        if(Math.hypot(x,y) > 0.1){
          camera.getWorldDirection(tmpFwd);
          tmpFwd.y = 0; tmpFwd.normalize();
          tmpRight.crossVectors(tmpFwd,camera.up).normalize(); // 右方向
          playerRig.position
                   .addScaledVector(tmpFwd, -y * MOVE_SPEED)   // 前後
                   .addScaledVector(tmpRight, x * MOVE_SPEED); // 左右
        }
      }

      /* 右コントローラー：回転 & ジャンプ */
      if(src.handedness === 'right'){
        /* スナップターン */
        if(Math.abs(x) > SNAP_DEAD && time - lastSnap > SNAP_COOL){
          playerRig.rotation.y += (x > 0 ? -SNAP_ANGLE : SNAP_ANGLE);
          lastSnap = time;
        }

        /* B ボタンで 180° ターン */
        const bPress = g.buttons[1]?.pressed;
        if(bPress && !src.userData.prevButtons[1]){
          playerRig.rotation.y += Math.PI;
        }

        /* A ボタンでジャンプ */
        const aPress = g.buttons[0]?.pressed;
        if(aPress && !src.userData.prevButtons[0] && playerRig.userData.canJump){
          playerRig.userData.yVel = JUMP_SPEED;
          playerRig.userData.canJump = false;
        }
      }

      /* ボタン状態を保存 */
      src.userData.prevButtons = g.buttons.map(b=>b.pressed);
    }
  }

  /* ─ ジャンプ垂直処理 ─ */
  if(!playerRig.userData.canJump){
    playerRig.position.y += playerRig.userData.yVel;
    playerRig.userData.yVel -= GRAVITY;
    if(playerRig.position.y <= 0){
      playerRig.position.y = 0;
      playerRig.userData.yVel = 0;
      playerRig.userData.canJump = true;
    }
  }

  renderer.render(scene,camera);
});

/* ───────────── VR セッション開始 ─────────────────── */
document.getElementById('startVR').addEventListener('click',async()=>{
  if(!navigator.xr){ alert('WebXR 未対応'); return; }
  try{
    const s = await navigator.xr.requestSession('immersive-vr',{requiredFeatures:['local-floor']});
    renderer.xr.setReferenceSpaceType('local-floor');
    renderer.xr.setSession(s);
  }catch(e){
    alert('VR 開始失敗: '+e.message);
  }
});

/* リサイズ対応 */
addEventListener('resize',()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
