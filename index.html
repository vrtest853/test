<!-- file: index.html  ★https (localhost が推奨) で配信してください -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>WebXR Quest Locomotion Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>body{margin:0;overflow:hidden;background:#000}</style>
</head>
<body>
<script type="module">
import * as THREE       from "https://unpkg.com/three@0.157.0/build/three.module.js";
import { VRButton }     from "https://unpkg.com/three@0.157.0/examples/jsm/webxr/VRButton.js";

/* ---------- 基本セットアップ ---------- */
const scene    = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

const camera   = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 100);
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);
document.body.appendChild( VRButton.createButton(renderer) );

/* ---------- 環境・ライティング ---------- */
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));
const floorMat = new THREE.MeshStandardMaterial({ color:0x808080, roughness:1 });
const floor    = new THREE.Mesh(new THREE.PlaneGeometry(200,200), floorMat);
floor.rotation.x = -Math.PI/2;   scene.add(floor);
scene.add(new THREE.GridHelper(200, 200, 0x444444, 0x444444));

/* ---------- プレイヤー（移動ラグドール） ---------- */
const player = new THREE.Group();
player.add(camera);          // カメラをプレイヤーノード下にぶら下げる
scene.add(player);

/* ---------- コントローラ参照 ---------- */
const leftController  = renderer.xr.getControllerGrip(0);   // left hand
const rightController = renderer.xr.getControllerGrip(1);   // right hand
scene.add(leftController, rightController);

/* ---------- 物理パラメータ ---------- */
const MOVE_SPEED  = 3.0;          // m/s
const TURN_SPEED  = Math.PI;      // rad/s
const JUMP_V      = 4.0;          // m/s (初速度)
const GRAVITY     = -9.8;         // m/s²

let yVel = 0, prev = 0;

/* ---------- メインループ ---------- */
renderer.setAnimationLoop( (time, frame)=>{
  const dt = (time - prev) * 0.001;   // 秒
  prev = time;

  if (frame) {
    for (const src of frame.session.inputSources) {
      if (!src.gamepad) continue;
      const gp = src.gamepad;
      const h  = src.handedness;         // "left" / "right"

      /* === 左スティック：移動 === */
      if (h === "left") {
        const strafe =  gp.axes[2] || 0;   // +右 / -左
        const fwd    = -gp.axes[3] || 0;   // +前 / -後（Horizon流）

        if (Math.abs(strafe) > 0.05 || Math.abs(fwd) > 0.05){
          // ヘッド方向を基準に水平移動ベクトルを生成
          const dir = new THREE.Vector3();
          camera.getWorldDirection(dir);
          dir.y = 0; dir.normalize();

          const right = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0)).normalize();

          const move = new THREE.Vector3()
              .addScaledVector(dir,    fwd)
              .addScaledVector(right,  strafe)
              .multiplyScalar(MOVE_SPEED * dt);

          player.position.add(move);
        }
      }

      /* === 右スティック：視点回転 === */
      if (h === "right") {
        const yaw = -gp.axes[2] || 0;           // +右回転
        player.rotation.y += yaw * TURN_SPEED * dt;

        /* --- A ボタン：ジャンプ（buttons[0]) --- */
        if (gp.buttons[0].pressed && Math.abs(player.position.y) < 0.01){
          yVel = JUMP_V;
        }
      }
    }
  }

  /* === 重力処理 === */
  yVel += GRAVITY * dt;
  player.position.y += yVel * dt;
  if (player.position.y < 0){
    player.position.y = 0;
    yVel = 0;
  }

  renderer.render(scene, camera);
});

/* ---------- リサイズ対応 ---------- */
addEventListener("resize", ()=>{
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
