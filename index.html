<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
	<title>Quest / Mobile 共用 WebXR サンプル</title>
	<style>body{margin:0;overflow:hidden;background:#000}</style>

	<!-- three.js r176 ＆ examples を CDN から取得 -->
	<script type="importmap">
	{
	  "imports": {
	    "three"           : "https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.module.js",
	    "three/addons/"   : "https://cdn.jsdelivr.net/npm/three@0.176.0/examples/jsm/"
	  }
	}
	</script>
</head>
<body>

<script type="module">
/* ===== 依存モジュール ===== */
import * as THREE from 'three';
import { VRButton }                   from 'three/addons/webxr/VRButton.js';
import { XRControllerModelFactory }   from 'three/addons/webxr/XRControllerModelFactory.js';
import { DeviceOrientationControls }  from 'three/addons/controls/DeviceOrientationControls.js';

/* ===== シーン初期化 ===== */
const scene   = new THREE.Scene();
const camera  = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 100);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

/* ===== VRButton（WebXR 非対応なら自動で “NOT AVAILABLE” 表示）===== */
document.body.appendChild(VRButton.createButton(renderer));

scene.add(new THREE.AmbientLight(0xffffff, 0.3));
const dir = new THREE.DirectionalLight(0xffffff, 1); dir.position.set(5,10,2); scene.add(dir);

const grid = new THREE.GridHelper(20, 20, 0x444444, 0x222222); scene.add(grid);

/* ===== プレイヤーリグ ===== */
const player = new THREE.Group(); player.position.set(0,1.6,3); player.add(camera); scene.add(player);

/* ===== デモ用キューブ ===== */
const cube = new THREE.Mesh(
  new THREE.BoxGeometry(0.4,0.4,0.4),
  new THREE.MeshStandardMaterial({color:0x0077aa})
);
cube.position.set(0,1.4,-2); scene.add(cube);

/* ===== コントローラ（VR用）===== */
const controllerModelFactory = new XRControllerModelFactory();
const rayGeom = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-1)]);
const controllers = [];

[0,1].forEach(i=>{
  const ctrl = renderer.xr.getController(i);
  ctrl.add(new THREE.Line(rayGeom, new THREE.LineBasicMaterial({color:0xffff00})));
  ctrl.userData.raycaster = new THREE.Raycaster();
  ctrl.addEventListener('selectstart',()=>{ const hit=intersect(ctrl); if(hit){ hit.material.color.setHex(Math.random()*0xffffff);} });
  scene.add(ctrl);

  const grip = renderer.xr.getControllerGrip(i);
  grip.add(controllerModelFactory.createControllerModel(grip));
  scene.add(grip);

  controllers.push(ctrl);
});

function intersect(ctrl){
  const mat = new THREE.Matrix4().extractRotation(ctrl.matrixWorld);
  ctrl.userData.raycaster.ray.origin.setFromMatrixPosition(ctrl.matrixWorld);
  ctrl.userData.raycaster.ray.direction.set(0,0,-1).applyMatrix4(mat);
  const hit = ctrl.userData.raycaster.intersectObject(cube);
  return hit[0]?.object ?? null;
}

/* ===== スティック歩行 & スナップ回転（VR時のみ）===== */
const clock = new THREE.Clock();
const walkSpeed = 3;
const snap = THREE.MathUtils.degToRad(30);
let prevX = 0;
function handleGamepad(ctrl,dt){
  const gp = ctrl?.inputSource?.gamepad; if(!gp) return;
  const [x,y] = gp.axes;

  if(Math.abs(y) > 0.2){
    player.position.add(new THREE.Vector3(0,0,-y*dt*walkSpeed).applyQuaternion(camera.quaternion));
  }
  if(Math.abs(x) > 0.6 && Math.abs(prevX) <= 0.6){ player.rotation.y -= Math.sign(x)*snap; }
  prevX = x;
}

/* =========================================================
   === WebXR 非対応端末（iPhone Safari など）のフォールバック ===
   ========================================================= */
let mobileControls = null;

if(!navigator.xr){                             // WebXR が存在しない端末
  mobileControls = new DeviceOrientationControls(camera);

  // iOS 13+ ではユーザ許可が必要
  if(typeof DeviceMotionEvent !== 'undefined' &&
     typeof DeviceMotionEvent.requestPermission === 'function'){

    const permBtn = document.createElement('button');
    permBtn.textContent = 'TAP TO ENABLE MOTION';
    Object.assign(permBtn.style,{
      position:'absolute',top:'50%',left:'50%',
      transform:'translate(-50%,-50%)',
      padding:'1rem 2rem',fontSize:'1.1rem',zIndex:10
    });
    permBtn.addEventListener('click', async ()=>{
      try{
        await DeviceMotionEvent.requestPermission();
        permBtn.remove();
      }catch(e){ alert('センサー使用が許可されませんでした'); }
    });
    document.body.appendChild(permBtn);
  }
}

/* ===== レンダーループ ===== */
renderer.setAnimationLoop(()=>{
  const dt = clock.getDelta();
  controllers.forEach(c=>handleGamepad(c,dt));      // VR 時
  if(mobileControls) mobileControls.update();       // モバイル時
  renderer.render(scene,camera);
});

/* ===== リサイズ ===== */
addEventListener('resize',()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
