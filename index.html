<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>VR街づくりテスト – 青空＆草地</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    #startVR {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10;
      padding: 10px 20px;
      font-size: 1.2em;
      background: #4caf50;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<button id="startVR">VRモード開始</button>

<!-- すべて ES Modules で記述（Sky.js を import するため） -->
<script type="module">
/* ── 依存ライブラリ ─────────────────────────── */
import * as THREE        from 'https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js';
import { Sky }           from 'https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/objects/Sky.js';

/* ── Renderer / Scene / Camera / Rig ─────────── */
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio( window.devicePixelRatio );
renderer.setSize( innerWidth, innerHeight );
renderer.xr.enabled = true;
document.body.appendChild( renderer.domElement );

const scene = new THREE.Scene();

const playerRig = new THREE.Group();
scene.add( playerRig );

const camera = new THREE.PerspectiveCamera( 70, innerWidth / innerHeight, 0.1, 1000 );
camera.position.set( 0, 1.6, 3 );
playerRig.add( camera );

/* ── 青空（Sky.js）───────────────────────────── */
const sky = new Sky();
sky.scale.setScalar( 450000 );
scene.add( sky );
const sun = new THREE.Vector3();
sun.setFromSphericalCoords( 1, THREE.MathUtils.degToRad( 90 - 20 ), THREE.MathUtils.degToRad( 180 ) ); // 高度20°
sky.material.uniforms[ 'sunPosition' ].value.copy( sun );
sky.material.uniforms[ 'turbidity' ].value = 10;
sky.material.uniforms[ 'rayleigh' ].value  = 2;
sky.material.uniforms[ 'mieCoefficient' ].value = 0.003;
sky.material.uniforms[ 'mieDirectionalG' ].value = 0.9;

/* ── ライティング ────────────────────────────── */
const hemi = new THREE.HemisphereLight( 0xffffff, 0x444444, 0.6 );
scene.add( hemi );
const sunLight = new THREE.DirectionalLight( 0xffffff, 0.9 );
sunLight.position.set( 100, 200, 100 );
scene.add( sunLight );

/* ── 草地の地面 ──────────────────────────────── */
const tex = new THREE.TextureLoader().load(
  'https://dl.polyhaven.org/file/ph-assets/Textures/jpg/2k/grass_short_01/grass_short_01_diff_2k.jpg',
  t => { t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set( 200, 200 ); }
);
tex.colorSpace = THREE.SRGBColorSpace;
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry( 1000, 1000 ),
  new THREE.MeshStandardMaterial( { map: tex } )
);
ground.rotation.x = - Math.PI / 2;
scene.add( ground );

/* ── テスト用オブジェクト ────────────────────── */
scene.add( new THREE.GridHelper( 50, 50 ) );
const cube = new THREE.Mesh( new THREE.BoxGeometry( 1, 1, 1 ), new THREE.MeshNormalMaterial() );
cube.position.set( 0, 1.6, -4 );
scene.add( cube );

/* ── 入力パラメータ ─────────────────────────── */
const tmpFwd  = new THREE.Vector3();
const tmpSide = new THREE.Vector3();
const MOVE    = 0.05;
const ROT     = 0.03;
const JUMP    = 0.18;
const GRAV    = 0.0098;

playerRig.userData.yVel    = 0;
playerRig.userData.canJump = true;

/* ── Animation Loop ─────────────────────────── */
renderer.setAnimationLoop( ( _, frame ) => {

  cube.rotation.x += 0.01;
  cube.rotation.y += 0.01;

  const session = renderer.xr.getSession();
  if ( session && frame ) {
    for ( const src of session.inputSources ) {
      if ( !src.gamepad ) continue;
      const g  = src.gamepad;
      const xi = g.axes.length >= 4 ? 2 : 0;
      const yi = xi + 1;
      const x  = g.axes[ xi ], y = g.axes[ yi ];

      if ( src.handedness === 'left' ) {
        /* 左スティック：移動 */
        if ( Math.hypot( x, y ) > 0.1 ) {
          camera.getWorldDirection( tmpFwd ); tmpFwd.y = 0; tmpFwd.normalize();
          tmpSide.crossVectors( camera.up, tmpFwd ).normalize();
          playerRig.position
                   .addScaledVector( tmpFwd, -y * MOVE )
                   .addScaledVector( tmpSide, -x * MOVE );    // 左右反転
        }
      } else if ( src.handedness === 'right' ) {
        /* 右スティック左右：回転 */
        if ( Math.abs( x ) > 0.15 ) playerRig.rotation.y -= x * ROT;

        /* A ボタン (index 0) でジャンプ */
        if ( g.buttons[ 0 ]?.pressed && playerRig.userData.canJump ) {
          playerRig.userData.yVel    = JUMP;
          playerRig.userData.canJump = false;
        }
      }
    }
  }

  /* ジャンプ物理 */
  if ( !playerRig.userData.canJump ) {
    playerRig.position.y += playerRig.userData.yVel;
    playerRig.userData.yVel -= GRAV;
    if ( playerRig.position.y <= 0 ) {
      playerRig.position.y     = 0;
      playerRig.userData.yVel  = 0;
      playerRig.userData.canJump = true;
    }
  }

  renderer.render( scene, camera );
});

/* ── VR セッション開始 ───────────────────────── */
document.getElementById( 'startVR' ).addEventListener( 'click', async () => {
  if ( !navigator.xr ) { alert( 'WebXR 非対応' ); return; }
  try {
    const s = await navigator.xr.requestSession( 'immersive-vr', { optionalFeatures:[ 'local-floor' ] } );
    const ref = await s.requestReferenceSpace( 'local-floor' ).catch( () => s.requestReferenceSpace( 'local' ) );
    renderer.xr.setReferenceSpace( ref );
    renderer.xr.setSession( s );
  } catch ( e ) { alert( 'VR 開始失敗: ' + e.message ); }
});

/* ── リサイズ対応 ───────────────────────────── */
addEventListener( 'resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize( innerWidth, innerHeight );
});
</script>
</body>
</html>
