<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VR街づくりテスト – Quest コントローラー移動対応</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!-- three.js 0.157.0 (最新安定版) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:black; }
    #startVR {
      position:fixed; top:20px; left:20px; z-index:10;
      padding:10px 20px; font-size:1.2em;
      background:#4CAF50; color:#fff; border:none; border-radius:5px;
      cursor:pointer;
    }
  </style>
</head>
<body>
<button id="startVR">VRモード開始</button>

<script>
/* ───── 基本セットアップ ─────────────────────────────── */
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x222222);

/* カメラを“殻”グループに入れて、殻を動かす */
const playerRig = new THREE.Group();
scene.add(playerRig);

const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 1.6, 3);
playerRig.add(camera);

/* 環境ライト */
scene.add(new THREE.AmbientLight(0xffffff, 0.5));
const hemi = new THREE.HemisphereLight(0xffffff, 0x444444);
hemi.position.set(0, 10, 0);
scene.add(hemi);

/* 床グリッド・デモオブジェクト・建物群 */
scene.add(new THREE.GridHelper(50, 50));

const cube = new THREE.Mesh(
  new THREE.BoxGeometry(1, 1, 1),
  new THREE.MeshNormalMaterial()
);
cube.position.set(0, 1.6, -4);
scene.add(cube);

const sphere = new THREE.Mesh(
  new THREE.SphereGeometry(0.7, 32, 32),
  new THREE.MeshBasicMaterial({ color: 0x00ffff })
);
sphere.position.set(3, 2.0, -5);
scene.add(sphere);

/* 小ビル配置 */
for (let i = -10; i <= 10; i += 4) {
  for (let j = -10; j <= 10; j += 4) {
    if (i === 0 && j === 0) continue;     // 中央は空ける
    const h = Math.random() * 5 + 2;
    const b = new THREE.Mesh(
      new THREE.BoxGeometry(1, h, 1),
      new THREE.MeshStandardMaterial({ color: 0x888888 })
    );
    b.position.set(i, h / 2, j - 10);
    scene.add(b);
  }
}

/* ───── アニメーション & コントローラー処理 ─────────────── */
const tmpFwd  = new THREE.Vector3();
const tmpSide = new THREE.Vector3();
const MOVE_SPEED = 0.05;    // m/フレーム ≒ 3 m/s
const ROT_SPEED  = 0.03;    // rad/フレーム

renderer.setAnimationLoop((t, frame) => {
  /* デモ: オブジェクト回転 */
  cube.rotation.x += 0.01;
  cube.rotation.y += 0.01;
  sphere.rotation.y += 0.02;

  /* ─ controller stick 操作 ─ */
  const session = renderer.xr.getSession();
  if (session && frame) {
    for (const src of session.inputSources) {
      if (!src.gamepad) continue;                 // hand-tracking等を除外
      const g = src.gamepad;

      /* Quest: axes[2] = X, axes[3] = Y ／ 他ブラウザ: [0],[1] */
      const xi = g.axes.length >= 4 ? 2 : 0;
      const yi = xi + 1;
      const x  = g.axes[xi];
      const y  = g.axes[yi];

      if (src.handedness === 'left') {
        /* 左スティックで移動 */
        if (Math.hypot(x, y) > 0.1) {             // デッドゾーン
          camera.getWorldDirection(tmpFwd);       // カメラ前方
          tmpFwd.y = 0; tmpFwd.normalize();
          tmpSide.crossVectors(camera.up, tmpFwd).normalize(); // 右方向
          playerRig.position
            .addScaledVector(tmpFwd, -y * MOVE_SPEED)          // 前後
            .addScaledVector(tmpSide,  x * MOVE_SPEED);        // 左右
        }
      } else if (src.handedness === 'right') {
        /* 右スティック左右で回転 */
        if (Math.abs(x) > 0.15) {
          playerRig.rotation.y -= x * ROT_SPEED;
        }
        /* 上下視点 (y) を使いたければ camera.rotation.x を調整 */
      }
    }
  }

  renderer.render(scene, camera);
});

/* ───── VRセッション開始ボタン ─────────────────────── */
document.getElementById('startVR').addEventListener('click', async () => {
  if (!navigator.xr) { alert('WebXR 未対応ブラウザです'); return; }
  try {
    const session = await navigator.xr.requestSession('immersive-vr', {
      requiredFeatures: ['local-floor']
    });
    renderer.xr.setReferenceSpaceType('local-floor');
    renderer.xr.setSession(session);
  } catch (e) {
    alert('VR セッション開始に失敗: ' + e.message);
  }
});

/* ───── リサイズ対応 ─────────────────────────────── */
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
